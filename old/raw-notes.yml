

  - name: newrelic-stemcell
    type: s3
    source:
      access_key_id: ((minio_access_key_id))
      secret_access_key: ((minio_secret_access_key))
      endpoint: ((minio_endpoint))
      bucket: ((minio_buckets_pivnet_products))
      regexp: newrelic-stemcell/bosh-stemcell-(.*)-vsphere.*\.tgz
      disable_ssl: true

  - name: newrelic-product
    type: s3
    source:
      access_key_id: ((minio_access_key_id))
      secret_access_key: ((minio_secret_access_key))
      endpoint: ((minio_endpoint))
      bucket: ((minio_buckets_pivnet_products))
      regexp: newrelic-broker-(.*).pivotal
      disable_ssl: true

  - name: newrelic-stemcell-config
    type: s3
    source:
      access_key_id: ((aws_access_key_id))
      secret_access_key: ((aws_secret_access_key))
      region_name: ((aws_region_name))
      bucket: ((aws_buckets_assign_stemcell_config))
      versioned_file: ((foundation))/newrelic/config.yml

  

  - name: metrics-stemcell
    type: s3
    source:
      access_key_id: ((minio_access_key_id))
      secret_access_key: ((minio_secret_access_key))
      endpoint: ((minio_endpoint))
      bucket: ((minio_buckets_pivnet_products))
      regexp: metrics-stemcell/bosh-stemcell-(.*)-vsphere.*\.tgz
      disable_ssl: true

  - name: metrics-product
    type: s3
    source:
      access_key_id: ((minio_access_key_id))
      secret_access_key: ((minio_secret_access_key))
      endpoint: ((minio_endpoint))
      bucket: ((minio_buckets_pivnet_products))
      regexp: apm-(.*).pivotal
      disable_ssl: true

  - name: metrics-stemcell-config
    type: s3
    source:
      access_key_id: ((aws_access_key_id))
      secret_access_key: ((aws_secret_access_key))
      region_name: ((aws_region_name))
      bucket: ((aws_buckets_assign_stemcell_config))
      versioned_file: ((foundation))/metrics/config.yml

  - name: fetch-newrelic
    plan:
    - aggregate:
      - get: platform-automation-image
        params:
          unpack: true
      - get: platform-automation-tasks
        params:
          unpack: true
      - get: configuration
    - task: credhub-interpolate
      image: platform-automation-image
      file: platform-automation-tasks/tasks/credhub-interpolate.yml
      params:
        CREDHUB_CLIENT: ((credhub_client))
        CREDHUB_SECRET: ((credhub_secret))
        CREDHUB_SERVER: ((credhub_server))
        CREDHUB_CA_CERT: ((credhub_ca_cert))
        PREFIX: /((foundation))
        INTERPOLATION_PATH: "((foundation))/download-product-configs"
      input_mapping:
        files: configuration
      output_mapping:
        interpolated-files: configuration
    - task: download-newrelic-product-and-stemcell
      image: platform-automation-image
      file: platform-automation-tasks/tasks/download-product.yml
      params:
        CONFIG_FILE: ((foundation))/download-product-configs/newrelic.yml
      input_mapping:
        config: configuration
      output_mapping: 
        downloaded-stemcell: newrelic-stemcell
        assign-stemcell-config: newrelic-stemcell-config
    - aggregate:
      - put: newrelic-product
        params:
          file: downloaded-product/*.pivotal
      - put: newrelic-stemcell
        params:
          file: newrelic-stemcell/*.tgz
      - put: newrelic-stemcell-config
        params:
          file: newrelic-stemcell-config/config.yml

  - name: upload-and-stage-newrelic
    serial: true
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
            passed:
              - fetch-newrelic
          - get: platform-automation-tasks
            params:
              unpack: true
            passed:
              - fetch-newrelic
          - get: newrelic-product
            trigger: true
            passed:
              - fetch-newrelic
          - get: newrelic-stemcell
            trigger: true
            passed:
              - fetch-newrelic
          - get: newrelic-stemcell-config
            trigger: true
            passed:
              - fetch-newrelic
          - get: configuration
          - get: variable
      - task: credhub-interpolate
        image: platform-automation-image
        file: platform-automation-tasks/tasks/credhub-interpolate.yml
        params:
          CREDHUB_CLIENT: ((credhub_client))
          CREDHUB_SECRET: ((credhub_secret))
          CREDHUB_SERVER: ((credhub_server))
          CREDHUB_CA_CERT: ((credhub_ca_cert))
          PREFIX: /((foundation))
          INTERPOLATION_PATH: "((foundation))"
        input_mapping:
          files: configuration
        output_mapping:
          interpolated-files: configuration
      - task: upload-product
        image: platform-automation-image
        file: platform-automation-tasks/tasks/upload-product.yml
        input_mapping:
          product: newrelic-product
          env: configuration
        params:
          ENV_FILE: ((foundation))/env/env.yml
      - task: stage-product
        image: platform-automation-image
        file: platform-automation-tasks/tasks/stage-product.yml
        input_mapping:
          product: newrelic-product
          env: configuration
        params:
          ENV_FILE: ((foundation))/env/env.yml
      - task: upload-newrelic-stemcell
        image: platform-automation-image
        file: platform-automation-tasks/tasks/upload-stemcell.yml
        input_mapping:
          env: configuration
          stemcell: newrelic-stemcell
        params:
          ENV_FILE: ((foundation))/env/env.yml
          FLOATING_STEMCELL: false
      - task: assign-newrelic-stemcell
        image: platform-automation-image
        file: platform-automation-tasks/tasks/assign-stemcell.yml
        input_mapping:
          env: configuration
          config: newrelic-stemcell-config
        params:
          ENV_FILE: ((foundation))/env/env.yml


  - name: fetch-metrics
    plan:
    - aggregate:
      - get: platform-automation-image
        params:
          unpack: true
      - get: platform-automation-tasks
        params:
          unpack: true
      - get: configuration
    - task: credhub-interpolate
      image: platform-automation-image
      file: platform-automation-tasks/tasks/credhub-interpolate.yml
      params:
        CREDHUB_CLIENT: ((credhub_client))
        CREDHUB_SECRET: ((credhub_secret))
        CREDHUB_SERVER: ((credhub_server))
        CREDHUB_CA_CERT: ((credhub_ca_cert))
        PREFIX: /((foundation))
        INTERPOLATION_PATH: "((foundation))/download-product-configs"
      input_mapping:
        files: configuration
      output_mapping:
        interpolated-files: configuration
    - task: download-metrics-product-and-stemcell
      image: platform-automation-image
      file: platform-automation-tasks/tasks/download-product.yml
      params:
        CONFIG_FILE: ((foundation))/download-product-configs/metrics.yml
      input_mapping:
        config: configuration
      output_mapping: 
        downloaded-stemcell: metrics-stemcell
        assign-stemcell-config: metrics-stemcell-config
    - aggregate:
      - put: metrics-product
        params:
          file: downloaded-product/*.pivotal
      - put: metrics-stemcell
        params:
          file: metrics-stemcell/*.tgz
      - put: metrics-stemcell-config
        params:
          file: metrics-stemcell-config/config.yml

  - name: upload-and-stage-metrics
    serial: true
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
            passed:
              - fetch-metrics
          - get: platform-automation-tasks
            params:
              unpack: true
            passed:
              - fetch-metrics
          - get: metrics-product
            trigger: true
            passed:
              - fetch-metrics
          - get: metrics-stemcell
            trigger: true
            passed:
              - fetch-metrics
          - get: metrics-stemcell-config
            trigger: true
            passed:
              - fetch-metrics
          - get: configuration
          - get: variable
      - task: credhub-interpolate
        image: platform-automation-image
        file: platform-automation-tasks/tasks/credhub-interpolate.yml
        params:
          CREDHUB_CLIENT: ((credhub_client))
          CREDHUB_SECRET: ((credhub_secret))
          CREDHUB_SERVER: ((credhub_server))
          CREDHUB_CA_CERT: ((credhub_ca_cert))
          PREFIX: /((foundation))
          INTERPOLATION_PATH: "((foundation))"
        input_mapping:
          files: configuration
        output_mapping:
          interpolated-files: configuration
      - task: upload-and-stage-product
        image: platform-automation-image
        file: platform-automation-tasks/tasks/upload-and-stage-product.yml
        input_mapping:
          product: metrics-product
          env: configuration
        params:
          ENV_FILE: ((foundation))/env/env.yml
      - task: upload-metrics-stemcell
        image: platform-automation-image
        file: platform-automation-tasks/tasks/upload-stemcell.yml
        input_mapping:
          env: configuration
          stemcell: metrics-stemcell
        params:
          ENV_FILE: ((foundation))/env/env.yml
          FLOATING_STEMCELL: false
      - task: assign-metrics-stemcell
        image: platform-automation-image
        file: platform-automation-tasks/tasks/assign-stemcell.yml
        input_mapping:
          env: configuration
          config: metrics-stemcell-config
        params:
          ENV_FILE: ((foundation))/env/env.yml